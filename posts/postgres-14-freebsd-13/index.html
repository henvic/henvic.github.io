<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Upgrading to PostgreSQL 14 on FreeBSD 13 | Henrique Vicente</title>
    <link href="https://fonts.googleapis.com/css?family=Raleway|Fira+Code|Comfortaa:300" rel="stylesheet">
    <link rel="stylesheet" href="/css/foundation-icons.css">
    <link rel="stylesheet" href="/css/foundation.min.css">
    <link rel="stylesheet" href="/webicons/webicons.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/henvic.css">
    <link rel="alternate" type="application/rss+xml" title="Henrique Vicente" href="/index.xml" />
    <link rel="shortcut icon" href="/favicon.ico">
    <meta property="og:title" content="Upgrading to PostgreSQL 14 on FreeBSD 13 | Henrique Vicente">
    <meta name="twitter:title" content="Upgrading to PostgreSQL 14 on FreeBSD 13 | Henrique Vicente" />
    <meta property="og:url" content="https://henvic.dev/posts/postgres-14-freebsd-13/">
    
    <meta name="description" content="In this blog post, I’ll show how to update PostgreSQL 14 on FreeBSD 13.">
    <meta property="og:description" content="In this blog post, I’ll show how to update PostgreSQL 14 on FreeBSD 13.">
    <meta name="twitter:description" content="In this blog post, I’ll show how to update PostgreSQL 14 on FreeBSD 13." />
    
    
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2021-11-11">
    
    <meta property="twitter:url" content="https://henvic.dev/posts/postgres-14-freebsd-13/">
    
    <meta name="og:image" content="https://henvic.dev/img/posts/postgres-14-freebsd-13/440px-Daemon-phk.svg.png" />
    <meta name="twitter:image" content="https://henvic.dev/img/posts/postgres-14-freebsd-13/440px-Daemon-phk.svg.png" />
    
</head>
<body><div class="grid-y medium-grid-frame">
        <nav class="title-bar show-for-small-only" data-responsive-toggle="responsive-menu" data-hide-for="medium">
    <button class="menu-icon" type="button" data-toggle="responsive-menu"></button>
    <div class="title-bar-title invisible">Menu</div>
</nav>
<nav class="top-bar show-for-small-only" id="responsive-menu">
    <div class="top-bar-right no-js">
        <ul class="dropdown menu vertical medium-horizontal large-horizontal" data-active-class="active" data-hover-delay="150" data-closing-time="80" data-alignment="left"
            data-dropdown-menu data-smooth-scroll>
            
            
            
            
            
                <li class=" ">
                    <a href="/" >
                        Home
                    </a>
                </li>
            
            
            
            
            
            
                <li class=" ">
                    <a href="/posts/" >
                        Blog posts
                    </a>
                </li>
            
            
            
            
            
            
                <li class=" ">
                    <a href="/talks/" >
                        Talks
                    </a>
                </li>
            
            
            
            
            
            
                <li class="show-for-small-only ">
                    <a href="/portfolio/" >
                        Portfolio
                    </a>
                </li>
            
            
                <li class="hide-for-small-only is-dropdown-submenu-parent ">
                    <a href="/portfolio/" >
                        Portfolio
                    </a>
                <ul class="vertical menu nested submenu">
                    
                    
                    <li >
                        <a href="/portfolio/#httpretty" title="httpretty">
                            httpretty
                        </a>
                    </li>
                    
                    
                    <li >
                        <a href="/portfolio/#wedeploy" title="WeDeploy CLI Tool">
                            WeDeploy CLI Tool
                        </a>
                    </li>
                    
                    
                    <li >
                        <a href="/portfolio/#vehikel" title="Vehikel">
                            Vehikel
                        </a>
                    </li>
                    
                    
                    <li >
                        <a href="/portfolio/#tic-tac-toe" title="Tic-tac-toe">
                            Tic-tac-toe
                        </a>
                    </li>
                    
                    
                    <li >
                        <a href="/portfolio/#accidents" title="accidents">
                            accidents
                        </a>
                    </li>
                    
                    
                    <li >
                        <a href="/portfolio/#topostit" title="to-post.it">
                            to-post.it
                        </a>
                    </li>
                    
                    
                    <li >
                        <a href="/portfolio/#trazqueeupago" title="trazqueeupago.com">
                            trazqueeupago.com
                        </a>
                    </li>
                    
                    
                    <li >
                        <a href="/portfolio/#cahier" title="Cahier">
                            Cahier
                        </a>
                    </li>
                    
                    
                    <li >
                        <a href="/portfolio/#plifk" title="Plifk">
                            Plifk
                        </a>
                    </li>
                    
                </ul>
                </li>
            
            
            
            
            
                <li class=" ">
                    <a href="/opensource/" >
                        Open Source
                    </a>
                </li>
            
            
            
            
            
            
                <li class=" ">
                    <a href="/favorites/" >
                        Favorites
                    </a>
                </li>
            
            
            
            
            
            
                <li class=" ">
                    <a href="/about/" >
                        About me
                    </a>
                </li>
            
            
            
            
            
            
                <li class=" ">
                    <a href="/resume.pdf" >
                        Résumé
                    </a>
                </li>
            
            
            
            
            
            
            
            
        </ul>
    </div>
</nav>

        <div class="cell medium-auto medium-cell-block-container">
            <div class="grid-x grid-padding-x">
                <div class="nav cell large-3 medium-4 large-cell-block-y medium-cell-block-y"><div itemscope itemtype="http://schema.org/Person">
    <div class="nav-card grid-x">
        <div class="cell small-2 medium-12 nav-card-photo-cell">
            <a href="/" itemprop="photo" class="nav-card-photo">
                <img src="/img/me_at_gullfoss_cropped.jpg" alt="me at Gullfoss" width="549" height="549" />
            </a>
        </div>
        <div class="cell card-section small-10 medium-12 medium-text-center">
            <h4 itemprop="name">Henrique Vicente</h4>
            <p>
                <span itemprop="title">Software Engineer</span>
            </p>
            <div class="menu-social">
                <a class="webicon github" href="https://github.com/henvic">
                    GitHub
                </a>
                <a class="webicon twitter" href="https://twitter.com/henriquev">
                    Twitter
                </a>
                <a class="webicon linkedin" href="https://www.linkedin.com/in/henvic">
                    Linkedin
                </a>
                <a class="webicon instagram" href="https://www.instagram.com/henvic/">
                    Instagram
                </a>
                <a class="webicon flickr" href="https://www.flickr.com/photos/henriquev/">
                    Flickr
                </a>
                <a class="webicon youtube" href="https://www.youtube.com/@henriquevicente">
                    YouTube
                </a>
                <a class="webicon rss" href="/index.xml" />
                rss feed
                </a>
                <a class="webicon mail" href="mailto:henriquevicente@gmail.com" itemprop="email">
                    henriquevicente@gmail.com
                </a>
                <br />
                <a href="https://keybase.io/henvic" class="fingerprint" title="Keybase profile">D0F4<span class="space"></span>DFBD<span
                        class="space"></span>257C<span class="space"></span>1575</a>
            </div>
        </div>
    </div>
    
    <nav aria-label="You are here:" role="navigation">
    <ul class="breadcrumbs" id="breadcrumbs">
            <li><a href="/"></a></li>
            <li><a href="/posts/">Blog posts</a></li>
            <li><a href="/posts/postgres-14-freebsd-13/">Upgrading to PostgreSQL 14 on FreeBSD 13</a></li>
    </ul>
</nav>
    <ul class="menu vertical show-for-medium">
        
        
        
        
        
        
        <li class="">
            <a href="/" >
                Home
            </a>
        </li>
        
        
        
        
        
        
        <li class=" active">
            <a href="/posts/" aria-current="page" >
                Blog posts
            </a>
        </li>
        
        
        
        
        
        
        <li class="">
            <a href="/talks/" >
                Talks
            </a>
        </li>
        
        
        
        
        
        
        <li class="">
            <a href="/portfolio/" >
                Portfolio
            </a>
        </li>
        
        
        
        
        
        
        <li class="">
            <a href="/opensource/" >
                Open Source
            </a>
        </li>
        
        
        
        
        
        
        <li class="">
            <a href="/favorites/" >
                Favorites
            </a>
        </li>
        
        
        
        
        
        
        <li class="">
            <a href="/about/" >
                About me
            </a>
        </li>
        
        
        
        
        
        
        <li class="">
            <a href="/resume.pdf" >
                Résumé
            </a>
        </li>
        
        
        
        
        
        
        
    </ul>
</div>
</div>

<article class="cell large-9 medium-8 large-cell-block-y medium-cell-block-y main">
        <h1 class="post-title">Upgrading to PostgreSQL 14 on FreeBSD 13</h1>
        
        
        <p class="post-date"><time class="stat" datetime="2021-11-11 00:00:00 &#43;0000 UTC"></time>Thursday, 11 November 2021</time>.</p>
        
        <p>In this blog post, I&rsquo;ll show how to update <a href="https://www.postgresql.org/about/news/postgresql-14-released-2318/">PostgreSQL 14</a> on FreeBSD 13.
Instead of running a database on my development machine, I run it on a FreeBSD virtual machine on my Intel NUC VMware ESXi <a href="/posts/homelab">homelab</a>, and connect to it from anywhere thanks to <a href="https://tailscale.com/">Tailscale</a>.</p>
<p>First, I started by making a backup of my data and locating where my current PostgreSQL configuration lives:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pg_dumpall -U pgsql | gzip &gt; backup.sql.gz
</span></span><span style="display:flex;"><span>$ ls /var/db/postgres/
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is an essential step, as you’ll see because I initialized a new database from scratch and recovered my customized settings and data later.</p>
<p><a href="https://www.freebsd.org/"><img src="/img/posts/postgres-14-freebsd-13/440px-Daemon-phk.svg.png" alt="Beastie"></a>
<a href="https://www.postgresql.org/"><img src="/img/posts/go-postgres/slonik_with_black_text_and_tagline.gif" alt="PostgreSQL mascot Slonik"></a></p>
<p>The next step was to <strong>update</strong> package repository catalogues and <strong>upgrade</strong> packaged software distributions:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pkg update
</span></span><span style="display:flex;"><span>$ pkg upgrade
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, I checked if PostgreSQL packages were available:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pkg search postgresql14
</span></span><span style="display:flex;"><span>pgtcl-postgresql14-2.1.1_2     TCL extension <span style="color:#66d9ef">for</span> accessing a PostgreSQL server <span style="color:#f92672">(</span>PGTCL-NG<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>postgresql14-client-14.0       PostgreSQL database <span style="color:#f92672">(</span>client<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>postgresql14-contrib-14.0      The contrib utilities from the PostgreSQL distribution
</span></span><span style="display:flex;"><span>postgresql14-docs-14.0         The PostgreSQL documentation set
</span></span><span style="display:flex;"><span>postgresql14-plperl-14.0       Write SQL functions <span style="color:#66d9ef">for</span> PostgreSQL using Perl5
</span></span><span style="display:flex;"><span>postgresql14-plpython-14.0     Module <span style="color:#66d9ef">for</span> using Python to write SQL functions
</span></span><span style="display:flex;"><span>postgresql14-pltcl-14.0        Module <span style="color:#66d9ef">for</span> using Tcl to write SQL functions
</span></span><span style="display:flex;"><span>postgresql14-server-14.0       PostgreSQL is the most advanced open-source database available anywhere
</span></span></code></pre></td></tr></table>
</div>
</div><p>Great! They are! Now, let&rsquo;s find out what version PostgreSQL it&rsquo;s installed, remove it, and install the newest version:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pkg info | grep postgresql
</span></span><span style="display:flex;"><span>postgresql12-client-12.8       PostgreSQL database <span style="color:#f92672">(</span>client<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>postgresql12-server-12.8       PostgreSQL is the most advanced open-source database available anywhere
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Shutdown the PostgreSQL database service:</span>
</span></span><span style="display:flex;"><span>$ service postgresql stop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Delete the old version:</span>
</span></span><span style="display:flex;"><span>$ pkg delete postgresql12-client postgresql12-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install version 14:</span>
</span></span><span style="display:flex;"><span>$ pkg install postgresql14-client postgresql14-server
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="settings">Settings</h2>
<p>Now, remember the <code>/var/db/postgres</code> directory I mentioned previously.
There, you&rsquo;ll find a new <code>/var/db/postgres/data14</code> directory alongside another directory named <code>data13</code> if you had version 13, <code>data12</code> if you had version 12, and so on.
Use the <code>diff</code> tool to compare configuration files and see what changes you need to apply to your new database.</p>
<p>Any changes you&rsquo;ve applied with <a href="https://www.postgresql.org/docs/current/sql-altersystem.html">ALTER SYSTEM</a> will be found on the postgresql.auto.conf file.</p>
<p>In my case, I had:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@bsd:/var/db/postgres/data12 <span style="color:#75715e"># cat postgresql.auto.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Do not edit this file manually!</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># It will be overwritten by the ALTER SYSTEM command.</span>
</span></span><span style="display:flex;"><span>wal_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;logical&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Which I decided to copy to <code>/var/db/postgres/data14/postgresql.conf</code>, along with the following changes:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># Listen to external connections (and let firewall worry about blocking unwanted connections):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use :: to allow listening for all IPv6 addresses or * for both IPv4 and IPv6.</span>
</span></span><span style="display:flex;"><span>listen_addresses <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0.0.0.0&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To allow TLS connections I copied my server.crt and server.key files (along with a server.req file),</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@bsd:/var/db/postgres/data12 <span style="color:#75715e"># ls server.*</span>
</span></span><span style="display:flex;"><span>server.crt	server.key	server.req
</span></span><span style="display:flex;"><span>root@bsd:/var/db/postgres/data14 <span style="color:#75715e"># cp ../data12/server.* .</span>
</span></span><span style="display:flex;"><span>root@bsd:/var/db/postgres/data14 <span style="color:#75715e"># chown postgres:postgres server.crt server.key server.req</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, I turned on TLS on the <code>postgresql.conf</code> file with:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># - SSL -</span>
</span></span><span style="display:flex;"><span>ssl <span style="color:#f92672">=</span> on
</span></span></code></pre></td></tr></table>
</div>
</div><p>As I said previously, I&rsquo;m also using the <a href="https://www.postgresql.org/docs/current/protocol-logical-replication.html">Logical Streaming Replication Protocol</a> to ingest data into OpenSearch using a connector, so I had to tweak this knob for configuring the write-ahead log:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># WRITE-AHEAD LOG</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Settings -</span>
</span></span><span style="display:flex;"><span>wal_level <span style="color:#f92672">=</span> logical                    <span style="color:#75715e"># minimal, replica, or logical</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Alternatively, I could just run the following command, modifying postgresql.auto.conf (this specific change requires a restart, and it&rsquo;s unlikely you need it, by the way):</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">SYSTEM</span> <span style="color:#66d9ef">SET</span> wal_level <span style="color:#f92672">=</span> logical;
</span></span></code></pre></td></tr></table>
</div>
</div><p>I also had to edit the <a href="https://www.postgresql.org/docs/current/auth-pg-hba-conf.html">pg_hba.conf file</a> used for client authentication to add a few lines:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># Checking what are the changes I need to do:</span>
</span></span><span style="display:flex;"><span>root@bsd:/var/db/postgres/data14 diff pg_hba.conf ../data12/pg_hba.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p>Lines I had to add back:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt; <span style="color:#75715e"># Henrique&#39;s connections</span>
</span></span><span style="display:flex;"><span>&gt; host    all             all             100.117.1.1/32     password
</span></span><span style="display:flex;"><span>&gt; hostssl    all             all             100.117.1.1/32     password
</span></span><span style="display:flex;"><span>&gt; hostssl    all             all             100.117.1.1/32   cert
</span></span></code></pre></td></tr></table>
</div>
</div><p>Otherwise, I&rsquo;d have run into this error when trying to connect to the database from my laptop:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pgcli
</span></span><span style="display:flex;"><span>could not connect to server: Connection refused
</span></span><span style="display:flex;"><span>	Is the server running on host <span style="color:#e6db74">&#34;bsd.henvic.dev&#34;</span> <span style="color:#f92672">(</span>100.125.227.84<span style="color:#f92672">)</span> and accepting
</span></span><span style="display:flex;"><span>	TCP/IP connections on port 5432?
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="starting-postgresql">Starting PostgreSQL</h2>
<p>Now, I initialized a new database, and then started PostgreSQL as a service.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># Initialize the new PostgreSQL 14 version by running:</span>
</span></span><span style="display:flex;"><span>$ postgres initdb -D /var/db/postgres/data14
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Make PostgreSQL run automatically on boot time, if you haven&#39;t (see /etc/rc.conf):</span>
</span></span><span style="display:flex;"><span>$ sysrc postgresql_enable<span style="color:#f92672">=</span>yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># To start the service manually, run:</span>
</span></span><span style="display:flex;"><span>$ service postgresql start
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="restoring-your-backup">Restoring your backup</h2>
<p>Go back to the directory where you saved your database dump and run the following command to restore everything on your database:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ gzcat backup.sql.gz | psql -U postgres postgres
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once you restore your backup, you should be done and ready to use PostgreSQL.</p>
<p>You can try to connect to the database and run a few commands to check if everything works. If something goes wrong, the following commands might help you:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># Check service status:</span>
</span></span><span style="display:flex;"><span>$ service postgresql status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># List open TCPv4 ports:</span>
</span></span><span style="display:flex;"><span>$ sockstat -l4 -P tcp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># List open TCPv6 ports</span>
</span></span><span style="display:flex;"><span>$ sockstat -l6 -P tcp
</span></span></code></pre></td></tr></table>
</div>
</div><p>Running an old version? Read the blog post <a href="https://unflyingobject.com/posts/upgrading-postgresql-on-freebsd/">Upgrading PostgreSQL on FreeBSD</a> (2016) by <a href="https://unflyingobject.com/">Filipp Lepalaan</a>.</p>
<h2 id="logging">Logging</h2>
<p>While setting up, I ran into this error and needed more information to fix it:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@bsd:/var/db/postgres/data14 <span style="color:#75715e"># service postgresql start</span>
</span></span><span style="display:flex;"><span>pg_ctl: could not start server
</span></span><span style="display:flex;"><span>Examine the log output.
</span></span></code></pre></td></tr></table>
</div>
</div><p>I started looking for this log file and discovered that I had to set up part of the <a href="https://www.postgresql.org/docs/current/runtime-config-logging.html">error reporting and logging</a> infrastructure to gather logs.</p>
<p>To do so, I added the following line to /etc/syslog.conf:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>local0.*    /var/log/postgresql
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can use LOCAL0 through LOCAL7 as the preceding syslog_facility.</p>
<blockquote>
<p>You can set at what syslog facility to log using the following configuration: #syslog_facility = &lsquo;LOCAL0&rsquo;
Change the logserver facility if you are having a conflict with other applications.</p>
<p>Source: <a href="https://postgresqlco.nf/doc/en/param/syslog_facility/">PostgresqlCO.NF&rsquo;s syslog_facility</a></p>
</blockquote>
<p>I followed this <a href="https://serverfault.com/questions/943096/where-to-find-logs-from-postgres-11-1-on-freebsd-11-2/967959#967959">advice</a> and created a log file for PostgreSQL:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ touch /var/log/postgresql.log
</span></span><span style="display:flex;"><span>$ chown postgres:wheel /var/log/postgresql.log
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">640</span> /var/log/postgresql.log
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, I sent a <a href="https://en.wikipedia.org/wiki/SIGHUP">SIGHUP</a> signal meant to signal the daemon that its configuration file should be re-read and restarted PostgreSQL:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kill -HUP <span style="color:#e6db74">`</span>sudo cat /var/run/syslog.pid <span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>$ service postgresql start
</span></span><span style="display:flex;"><span>2021-11-09 21:16:58.545 CET <span style="color:#f92672">[</span>33755<span style="color:#f92672">]</span> FATAL:  could not load private key file <span style="color:#e6db74">&#34;server.key&#34;</span>: Permission denied
</span></span><span style="display:flex;"><span>2021-11-09 21:16:58.546 CET <span style="color:#f92672">[</span>33755<span style="color:#f92672">]</span> LOG:  database system is shut down
</span></span><span style="display:flex;"><span>pg_ctl: could not start server
</span></span><span style="display:flex;"><span>Examine the log output.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Interestingly the <code>service postgresql start</code> command now returns some logs, so I didn&rsquo;t even need to check the logs files.</p>
<p>You can read the stream of PostgreSQL logs with the following command:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ tail -f /var/log/postgresql.log
</span></span><span style="display:flex;"><span>Nov  <span style="color:#ae81ff">9</span> 21:16:58 bsd postgres<span style="color:#f92672">[</span>33755<span style="color:#f92672">]</span>: <span style="color:#f92672">[</span>1-1<span style="color:#f92672">]</span> 2021-11-09 21:16:58.545 CET <span style="color:#f92672">[</span>33755<span style="color:#f92672">]</span> FATAL:  could not load private key file <span style="color:#e6db74">&#34;server.key&#34;</span>: Permission denied
</span></span><span style="display:flex;"><span>Nov  <span style="color:#ae81ff">9</span> 21:16:58 bsd postgres<span style="color:#f92672">[</span>33755<span style="color:#f92672">]</span>: <span style="color:#f92672">[</span>2-1<span style="color:#f92672">]</span> 2021-11-09 21:16:58.546 CET <span style="color:#f92672">[</span>33755<span style="color:#f92672">]</span> LOG:  database system is shut down
</span></span></code></pre></td></tr></table>
</div>
</div><p>With the context of what was going on, it was pretty easy to spot the problem: the permissions for the certificate files were incorrect.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@bsd:/var/db/postgres/data14 <span style="color:#75715e"># ls -la</span>
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">106</span>
</span></span><span style="display:flex;"><span>drwx------  <span style="color:#ae81ff">19</span> postgres  postgres     <span style="color:#ae81ff">28</span> Nov  <span style="color:#ae81ff">9</span> 21:16 .
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#ae81ff">5</span> postgres  postgres      <span style="color:#ae81ff">6</span> Nov  <span style="color:#ae81ff">9</span> 20:24 ..
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#ae81ff">1</span> postgres  postgres      <span style="color:#ae81ff">3</span> Nov  <span style="color:#ae81ff">9</span> 20:24 PG_VERSION
</span></span><span style="display:flex;"><span>drwx------  <span style="color:#ae81ff">13</span> postgres  postgres     <span style="color:#ae81ff">13</span> Nov  <span style="color:#ae81ff">9</span> 20:25 base
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres     <span style="color:#ae81ff">60</span> Nov  <span style="color:#ae81ff">9</span> 21:00 global
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">2</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_commit_ts
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">2</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_dynshmem
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#ae81ff">1</span> postgres  postgres   <span style="color:#ae81ff">5367</span> Nov  <span style="color:#ae81ff">9</span> 20:59 pg_hba.conf
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#ae81ff">1</span> postgres  postgres   <span style="color:#ae81ff">1636</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_ident.conf
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">4</span> postgres  postgres      <span style="color:#ae81ff">5</span> Nov  <span style="color:#ae81ff">9</span> 21:09 pg_logical
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">4</span> postgres  postgres      <span style="color:#ae81ff">4</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_multixact
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">2</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_notify
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">2</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_replslot
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">2</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_serial
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">2</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_snapshots
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres     <span style="color:#ae81ff">13</span> Nov  <span style="color:#ae81ff">9</span> 21:09 pg_stat
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">2</span> Nov  <span style="color:#ae81ff">9</span> 21:09 pg_stat_tmp
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">3</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_subtrans
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">2</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_tblspc
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">2</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_twophase
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">3</span> postgres  postgres     <span style="color:#ae81ff">29</span> Nov  <span style="color:#ae81ff">9</span> 20:34 pg_wal
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#ae81ff">2</span> postgres  postgres      <span style="color:#ae81ff">3</span> Nov  <span style="color:#ae81ff">9</span> 20:24 pg_xact
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#ae81ff">1</span> postgres  postgres     <span style="color:#ae81ff">88</span> Nov  <span style="color:#ae81ff">9</span> 20:24 postgresql.auto.conf
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#ae81ff">1</span> postgres  postgres  <span style="color:#ae81ff">28915</span> Nov  <span style="color:#ae81ff">9</span> 21:09 postgresql.conf
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#ae81ff">1</span> postgres  postgres     <span style="color:#ae81ff">55</span> Nov  <span style="color:#ae81ff">9</span> 20:59 postmaster.opts
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#ae81ff">1</span> root      postgres   <span style="color:#ae81ff">4631</span> Nov  <span style="color:#ae81ff">9</span> 21:09 server.crt
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#ae81ff">1</span> root      postgres   <span style="color:#ae81ff">1675</span> Nov  <span style="color:#ae81ff">9</span> 21:09 server.key
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#ae81ff">1</span> root      postgres   <span style="color:#ae81ff">3569</span> Nov  <span style="color:#ae81ff">9</span> 21:10 server.req
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Cause:</strong> I had copied the files while logged in as <code>root</code>, but forgot to set their group owner to <code>postgres</code>.</p>
<p>Let&rsquo;s fix this:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@bsd:/var/db/postgres/data14 <span style="color:#75715e"># chown postgres:postgres server.crt server.key server.req</span>
</span></span><span style="display:flex;"><span>root@bsd:/var/db/postgres/data14 <span style="color:#75715e"># ls -la server.*</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> postgres  postgres  <span style="color:#ae81ff">4631</span> Nov  <span style="color:#ae81ff">9</span> 21:09 server.crt
</span></span><span style="display:flex;"><span>-rw-------  <span style="color:#ae81ff">1</span> postgres  postgres  <span style="color:#ae81ff">1675</span> Nov  <span style="color:#ae81ff">9</span> 21:09 server.key
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> postgres  postgres  <span style="color:#ae81ff">3569</span> Nov  <span style="color:#ae81ff">9</span> 21:10 server.req
</span></span></code></pre></td></tr></table>
</div>
</div><p>Running <code>service postgresql start</code> again worked like a charm!</p>
<p>Next, I&rsquo;ve checked connectivity from my laptop. Finally, everything worked, including the database replication protocol I use at work for ingesting data into a search engine (but that topic is for an upcoming post, hopefully, in a couple of months).</p>
<p>Once you verify the migration happened successfully, you can get rid of your old <code>/var/db/postgres/data&lt;version&gt;</code> directory.</p>
<p>I hope you find this article useful somehow.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Upgrading to PostgreSQL 14 on FreeBSD 13<a href="https://t.co/1a4geZuTqZ">https://t.co/1a4geZuTqZ</a><a href="https://twitter.com/hashtag/postgresql?src=hash&amp;ref_src=twsrc%5Etfw">#postgresql</a> <a href="https://twitter.com/hashtag/postgres?src=hash&amp;ref_src=twsrc%5Etfw">#postgres</a> <a href="https://twitter.com/hashtag/freebsd?src=hash&amp;ref_src=twsrc%5Etfw">#freebsd</a></p>&mdash; Henrique Vicente (@henriquev) <a href="https://twitter.com/henriquev/status/1458767291315896328?ref_src=twsrc%5Etfw">November 11, 2021</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p><small>If you click and buy any of these from Amazon after visiting the links above, I might get a commission from their <a href="https://affiliate-program.amazon.com/">Affiliate program</a>.</small></p>

                <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large"
                        data-text="Upgrading to PostgreSQL 14 on FreeBSD 13" data-url="https://henvic.dev/posts/postgres-14-freebsd-13/" data-via="henriquev"
                        data-hashtags="postgresql,postgres,freebsd"  data-show-count="false">Tweet</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        <aside class="read-also">
                <h3>Read also</h3>
                <ul>
                        <li>
                                <a href="/posts/testing-go/">On testing Go code using the standard library</a>
                                <time datetime="2006-01-02">Tuesday 18, June 2024</time>
                        </li><li>
                                <a href="/posts/tesla/">My new Tesla Model Y 2023</a>
                                <time datetime="2006-01-02">Wednesday 11, January 2023</time>
                        </li><li>
                                <a href="/posts/go-utf8/">UTF-8 strings with Go: len(s) isn&#39;t enough</a>
                                <time datetime="2006-01-02">Monday 7, March 2022</time>
                        </li><li>
                                <a href="/posts/go-postgres/">Back to basics: Writing an application using Go and PostgreSQL</a>
                                <time datetime="2006-01-02">Monday 22, November 2021</time>
                        </li><li>
                                <a href="/posts/uuid/">You don&#39;t need UUID</a>
                                <time datetime="2006-01-02">Sunday 30, May 2021</time>
                        </li><li>
                                <a href="/posts/go/">The ecosystem of the Go programming language</a>
                                <time datetime="2006-01-02">Monday 22, March 2021</time>
                        </li><li>
                                <a href="/posts/my-go-mistakes/">My Go mistakes</a>
                                <time datetime="2006-01-02">Thursday 18, February 2021</time>
                        </li><li>
                                <a href="/posts/env/">Environment variables, config, secrets, and globals</a>
                                <time datetime="2006-01-02">Saturday 16, January 2021</time>
                        </li><li>
                                <a href="/posts/signal-notify-context/">signal.NotifyContext: handling cancelation with Unix signals using context</a>
                                <time datetime="2006-01-02">Wednesday 16, September 2020</time>
                        </li><li>
                                <a href="/posts/e-commerce/">I&#39;m starting an opensource e-commerce project.</a>
                                <time datetime="2006-01-02">Wednesday 17, June 2020</time>
                        </li>
                </ul>
        </aside>
</article>

            </div>
        </div>
    </div>

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y1GFSFWX85"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-Y1GFSFWX85');
        }
      </script>
<script src="/js/vendor/modernizr-custom-svg.js"></script>
<script src="/js/vendor/what-input.js"></script>
<script src="/js/vendor/jquery.min.js"></script>
<script src="/js/vendor/foundation.min.js"></script>
<script>
        $(document).ready(function () {
                $(document).foundation();
        });
</script>
</body>
</html>
